{% extends "base.html" %}
{% load static %}

{% block title %}Orders Â· Restaurant System{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/orders.css' %}">
{% endblock %}

{% block content %}
<div class="order-container">
  <!-- Header row: Left = Place New Order, Right = Search + timestamp -->
  <div class="table-header">
    <h2>ðŸ§¾ Orders</h2>
    <div class="header-right">
      <div class="header-right-top">
        <a class="btn-primary btn-icon" href="{% url 'orders:create' %}">
          <span>âž•</span><span>Place New Order</span>
        </a>
        <input id="order-search" class="search-input" type="search"
               placeholder="Search by ID, table, customer, or itemâ€¦">
      </div>
      <div class="timestamp muted">
        Updated {% now "Y-m-d H:i" %}
      </div>
    </div>
  </div>

  {% if orders %}
  <div class="table-wrap">
    <table class="data-table" id="orders-table">
      <thead>
        <tr>
          <th style="width: 90px;">ID</th>
          <th style="width: 120px;">Table</th>
          <th style="width: 220px;">Customer</th>
          <th>Items</th>
          <th style="width: 130px;">Status</th>
          <th class="hide-sm" style="width: 180px;">Created</th>
          <th style="width: 290px;">Actions</th>
        </tr>
      </thead>
      <tbody>
      {% for order in orders %}
        <tr
          data-search="{{ order.id }} {{ order.table_number|default_if_none:'' }} {{ order.customer.username }} {% for line in order.order_items.all %} {{ line.menu_item.name }} {% endfor %}">
          <td class="mono">#{{ order.id }}</td>

          <td>
            {% if order.table_number %}
              <span class="badge">{{ order.table_number }}</span>
            {% else %}
              <span class="muted">â€”</span>
            {% endif %}
          </td>

          <td class="customer-cell nowrap">
            <span class="avatar">{{ order.customer.username|first|upper }}</span>
            <span class="customer-name">{{ order.customer.username }}</span>
          </td>

          <td>
            {% if order.order_items.all %}
              <div class="chips">
                {% for line in order.order_items.all %}
                  <span class="chip" title="{{ line.menu_item.name }}">
                    {{ line.menu_item.name }} Ã— {{ line.quantity }}
                  </span>
                {% empty %}
                  <em class="muted">No items</em>
                {% endfor %}
              </div>
            {% else %}
              <em class="muted">No items</em>
            {% endif %}
          </td>

          <td class="nowrap">
            {% with s=order.status %}
              <span class="status-badge
                {% if s == 'pending' %} pending
                {% elif s == 'preparing' %} preparing
                {% elif s == 'completed' %} completed
                {% elif s == 'cancelled' %} cancelled
                {% endif %}">
                {{ order.get_status_display }}
              </span>
            {% endwith %}
          </td>

          <td class="nowrap hide-sm">{{ order.created_at|date:"Y-m-d H:i" }}</td>

          <td class="nowrap">
            <div class="row-actions">
              {# Managers/Admins: status transitions #}
              {% if request.user.is_superuser or request.user.role in 'manager admin' %}
                {% if order.status == 'pending' %}
                  <form method="post" action="{% url 'orders:status' order.id 'preparing' %}">
                    {% csrf_token %}
                    <button class="btn-mini">Mark Preparing</button>
                  </form>
                  <form method="post" action="{% url 'orders:status' order.id 'cancelled' %}">
                    {% csrf_token %}
                    <button class="btn-mini danger">Cancel</button>
                  </form>
                {% elif order.status == 'preparing' %}
                  <form method="post" action="{% url 'orders:status' order.id 'completed' %}">
                    {% csrf_token %}
                    <button class="btn-mini success">Mark Completed</button>
                  </form>
                  <form method="post" action="{% url 'orders:status' order.id 'cancelled' %}">
                    {% csrf_token %}
                    <button class="btn-mini danger">Cancel</button>
                  </form>
                {% else %}
                  <span class="muted">â€”</span>
                {% endif %}

              {# Customers: only while pending and owner #}
              {% else %}
                {% if order.status == 'pending' and order.customer_id == request.user.id %}
                  <a class="btn-mini" href="{% url 'orders:update' order.id %}">Edit</a>
                  <form method="post"
                        action="{% url 'orders:delete' order.id %}"
                        onsubmit="return confirm('Cancel order #{{ order.id }}?')">
                    {% csrf_token %}
                    <button type="submit" class="btn-mini danger">Cancel</button>
                  </form>
                {% else %}
                  <span class="muted">â€”</span>
                {% endif %}
              {% endif %}
            </div>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <p class="muted">No orders yet.</p>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/order_list.js' %}"></script>
{% endblock %}
